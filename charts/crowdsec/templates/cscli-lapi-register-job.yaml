{{- if .Values.lapi.enabled }}
    {{- if eq (include "StoreLAPICscliCredentialsInSecret" .) "true" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-lapi-cscli-register-job
  labels:
    k8s-app: {{ .Release.Name }}
    type: lapi-cscli-register-job
    version: v1
    {{- if .Values.podLabels }}
{{ toYaml .Values.podLabels | trim | indent 4 }}
    {{- end }}
  annotations:
    "helm.sh/hook": "pre-install,pre-upgrade"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "0"
spec:
  template:
    metadata:
      labels:
        k8s-app: {{ .Release.Name }}
        type: lapi-cscli-register-job
        version: v1
        {{- if .Values.podLabels }}
{{ toYaml .Values.podLabels | trim | indent 8 }}
        {{- end }}
    spec:
      serviceAccountName: {{ .Release.Name }}-configmap-updater-sa
      restartPolicy: OnFailure
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.image.pullSecrets | indent 8 }}
      {{- end }}
      {{- if .Values.lapi.tolerations }}
      tolerations:
{{ toYaml .Values.lapi.tolerations | indent 8 }}
      {{- end }}
      initContainers:
        - name: install-kubectl
          image: {{ include "registerJobKubectlImage" . | quote }}
          imagePullPolicy: {{ .Values.image.kubectl.pullPolicy | default .Values.image.pullPolicy }}
          command:
            - "/bin/sh"
            - "-c"
            - |
                cp "$(command -v kubectl)" /kubectl-bin/kubectl
                chmod 0755 /kubectl-bin/kubectl
          volumeMounts:
            - name: kubectl-bin
              mountPath: /kubectl-bin
      containers:
        - name: lapi-cscli-register
          image: "{{ .Values.image.repository | default "crowdsecurity/crowdsec" }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          volumeMounts:
            - name: kubectl-bin
              mountPath: /kubectl-bin
          command:
            - "/bin/bash"
            - "-c"
            - |
                set -ex
                KUBECTL=/kubectl-bin/kubectl
                echo "Checking if the secret {{ .Release.Name }}-lapi-cscli-credentials already exists..."
                if $KUBECTL -n {{ .Release.Namespace }} get secret {{ .Release.Name }}-lapi-cscli-credentials >/dev/null 2>&1; then
                  echo "Secret already exists. Skipping registration."
                  exit 0
                fi

                echo "Secret does not exist. Generating cscli credentials for LAPI."
                
                echo "url: http://127.0.0.1:{{ .Values.agent.lapiPort | default "8080" }}" > /tmp/lapi-cscli-credentials.yaml
                echo "login: lapi-cscli" >> /tmp/lapi-cscli-credentials.yaml
                echo "password: $(head -c 32 /dev/urandom | base64)" >> /tmp/lapi-cscli-credentials.yaml
                
                echo "Creating secret {{ .Release.Name }}-lapi-cscli-credentials..."
                
                $KUBECTL create secret generic {{ .Release.Name }}-lapi-cscli-credentials \
                  -n {{ .Release.Namespace }} \
                  --from-file=lapi_cscli_credentials.yaml=/tmp/lapi-cscli-credentials.yaml
      volumes:
        - name: kubectl-bin
          emptyDir: {}
    {{- end }}
{{- end }}
