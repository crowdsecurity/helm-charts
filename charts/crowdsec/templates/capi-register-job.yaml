{{- if not (eq (include "IsOnlineAPIDisabled" .) "true") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-capi-register-job
  labels:
    k8s-app: {{ .Release.Name }}
    type: capi-register-job
    version: v1
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "0"
spec:
  template:
    spec:
      serviceAccountName: {{ .Release.Name }}-configmap-updater-sa
      restartPolicy: OnFailure
      volumes:
        - name: {{ .Release.Name }}-capi-credentials-volume
          configMap:
            name: {{ .Release.Name }}-capi-credentials
        {{- if .Values.lapi.persistentVolume.config.enabled }}
        - name: crowdsec-config
          persistentVolumeClaim:
            {{ if .Values.lapi.persistentVolume.config.existingClaim }}
            claimName: {{ .Values.lapi.persistentVolume.config.existingClaim }}
            {{ else }}
            claimName: {{ .Release.Name }}-config-pvc
            {{ end }}
        {{- end }}
      containers:
        - name: capi-register
          {{- if .Values.image.pullSecrets }}
          imagePullSecrets:
{{ toYaml .Values.image.pullSecrets | indent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository | default "crowdsecurity/crowdsec" }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - "/bin/bash"
            - "-c"
            - |
                apk update && apk add curl jq kubectl
                set -x
                echo "check if the Central API credentials are already present"
                cp /staging/etc/crowdsec/config.yaml /etc/crowdsec/config.yaml
                cp /staging/etc/crowdsec/profiles.yaml /etc/crowdsec/profiles.yaml
                sed -i /etc/crowdsec/config.yaml -e 's/#credentials_path/  credentials_path/'
                login=$(yq e '.login' /etc/crowdsec_data/online_api_credentials.yaml)
                if [ -n "$login" ] && [ "$login" != "null" ]; then
                    CONFIGMAP_CONTENT="$(cat /etc/crowdsec_data/online_api_credentials.yaml | base64 -w0)"
                    PATCH=$(jq -n --arg value "$(echo -e "$CONFIGMAP_CONTENT" | base64 -d)" '[{op: "replace", path: "/data/online_api_credentials.yaml", value: $value}]')

                    echo "Updating the Central API credentials in the configmap"
                    kubectl -n {{ .Release.Namespace }} patch configmap {{ .Release.Name }}-capi-credentials --type json -p "$PATCH"
                elif grep -q "placeholder" /etc/crowdsec/online_api_credentials.yaml; then
                    echo "Registering this instance to the Central API"
                    cscli capi register -f /tmp/online_api_credentials.yaml
                    CONFIGMAP_CONTENT="$(cat /tmp/online_api_credentials.yaml | base64 -w0)"
                    PATCH=$(jq -n --arg value "$(echo -e "$CONFIGMAP_CONTENT" | base64 -d)" '[{op: "replace", path: "/data/online_api_credentials.yaml", value: $value}]')

                    echo "Updating the Central API credentials in the configmap"
                    kubectl -n {{ .Release.Namespace }} patch configmap {{ .Release.Name }}-capi-credentials --type json -p "$PATCH"
                else
                    echo "Central API credentials are already present, skipping registration"
                    exit 0
                fi
          volumeMounts:
            - name: {{ .Release.Name }}-capi-credentials-volume
              mountPath: /etc/crowdsec/online_api_credentials.yaml
              subPath: online_api_credentials.yaml
            {{- if .Values.lapi.persistentVolume.config.enabled }}
            - name: crowdsec-config
              mountPath: /etc/crowdsec_data
            {{- end }}
{{- end }}